<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµé‡ç›‘æ§æ§åˆ¶å° Pro v1.0.0 æ­£å¼ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- é¢œè‰²å˜é‡ç³»ç»Ÿ --- */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #eff6ff;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            --danger: #ef4444;
            --danger-bg: #fff5f5;
            --success: #10b981;
            --shadow: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-hover: 0 8px 12px -2px rgba(0,0,0,0.05);
        }

        :root[data-theme="dark"] {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --primary-light: rgba(59, 130, 246, 0.1);
            --bg: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --input-bg: #0f172a;
            --danger: #f87171;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --success: #34d399;
            --shadow: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-hover: 0 8px 12px -2px rgba(0,0,0,0.5);
        }

        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: var(--bg); }
        body::-webkit-scrollbar-thumb { background: var(--card-border); border-radius: 4px; }

        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; font-size: 14px; -webkit-font-smoothing: antialiased; transition: background 0.3s ease, color 0.3s ease; }
        
        .app-layout { max-width: 1200px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .main-content { flex: 1; display: flex; flex-direction: column; }

        .page-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-end; }
        .page-title h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }
        .page-title span { font-size: 13px; color: var(--text-sub); font-weight: 500; margin-top: 4px; display: block; }

        .theme-toggle {
            background: var(--card-bg); border: 1px solid var(--card-border); width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-main);
            box-shadow: var(--shadow); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .theme-toggle:hover { transform: rotate(15deg) scale(1.05); box-shadow: var(--shadow-hover); border-color: var(--text-muted); }
        .theme-toggle svg { width: 20px; height: 20px; fill: currentColor; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--card-bg); padding: 24px; border-radius: 12px; border: 1px solid var(--card-border); box-shadow: var(--shadow); transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); border-color: var(--text-muted); }
        .stat-label { color: var(--text-sub); font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 30px; font-weight: 700; margin-top: 12px; color: var(--text-main); letter-spacing: -1px; }
        .stat-desc { font-size: 13px; color: var(--text-sub); margin-top: 8px; display: flex; align-items: center; gap: 6px; }

        .toolbar { display: flex; gap: 12px; margin-bottom: 16px; background: var(--card-bg); padding: 12px; border-radius: 12px; border: 1px solid var(--card-border); box-shadow: var(--shadow); }
        .search-input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; transition: all 0.2s; background: var(--input-bg); color: var(--text-main); }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .btn { padding: 0 16px; height: 40px; border: 1px solid var(--border); background: var(--card-bg); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--text-main); transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; }
        .btn:hover:not(:disabled) { background: var(--bg); border-color: var(--text-sub); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); border-color: var(--primary-hover); }
        .btn-danger { color: var(--danger); border-color: var(--danger); background: var(--danger-bg); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--card-border); overflow: hidden; box-shadow: var(--shadow); flex: 1; display: flex; flex-direction: column; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: var(--bg); text-align: left; padding: 14px 20px; font-size: 12px; color: var(--text-sub); font-weight: 600; border-bottom: 1px solid var(--border); transition: background 0.3s; }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); transition: background 0.2s; }
        tr:hover td { background: var(--bg); }
        tr:last-child td { border-bottom: none; }
        .td-no-border { border-bottom: none !important; }

        /* åˆ†é¡µæ æ ·å¼ */
        .pagination-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 20px; border-top: 1px solid var(--border); background: var(--bg);
        }
        .pagination-controls { display: flex; gap: 8px; align-items: center; }
        .page-info { font-size: 12px; color: var(--text-sub); font-weight: 500; }

        .key-badge { 
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 10px; padding: 2px 8px; 
            background: var(--bg); border: 1px solid var(--border); 
            border-radius: 4px; color: var(--text-muted); 
            cursor: pointer; font-family: monospace; margin-top: 6px;
            transition: all 0.2s;
            max-width: 240px;
            vertical-align: middle;
        }
        .key-badge span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 180px;
        }
        .key-badge:hover { border-color: var(--primary); color: var(--primary); background: var(--card-bg); }
        .key-badge svg { width: 10px; height: 10px; fill: currentColor; }

        .path-primary { font-weight: 500; color: var(--text-main); font-size: 14px; margin-bottom: 2px; line-height: 1.5; word-break: break-all; }
        .root-badge {
            background: var(--success); 
            color: white; 
            padding: 0 5px; 
            border-radius: 3px; 
            font-size: 11px; 
            margin-left: 6px;
            vertical-align: middle;
        }
        
        .th-path { width: 50%; }
        .th-heat { width: 25%; }
        .th-edit { width: 15%; text-align: center; }
        .th-action { width: 10%; text-align: right; }

        .pv-container { display: flex; align-items: center; gap: 12px; }
        .pv-bar-bg { flex: 1; height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
        .pv-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-hover)); border-radius: 4px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .pv-number { font-weight: 700; font-size: 13px; min-width: 50px; text-align: right; color: var(--text-main); }
        .mobile-bar-container { display: none; margin-top: 8px; align-items: center; gap: 8px; }
        
        .edit-input { width: 100%; max-width: 80px; padding: 6px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-size: 13px; font-weight: 500; background: var(--input-bg); color: var(--text-main); }
        .edit-input:focus { border-color: var(--primary); outline: none; }
        
        .site-footer { margin-top: 30px; padding: 20px 0; border-top: 1px dashed var(--border); color: var(--text-sub); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .footer-left { display: flex; align-items: center; gap: 15px; }
        .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .separator { color: var(--border); }

        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; pointer-events: none; }
        .toast { background: rgba(15, 23, 42, 0.95); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 500; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 10px; opacity: 0; transform: translateY(-20px); transition: all 0.3s; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(4px); }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .login-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80vh; padding: 20px; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 16px; border: 1px solid var(--card-border); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 380px; text-align: center; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-right: 6px; vertical-align: middle; }
        .badge-core { background: var(--primary-light); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.2); }

        .spinner { width: 14px; height: 14px; border: 2px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .app-layout { padding: 12px; }
            .page-title h1 { font-size: 20px; }
            .stat-value { font-size: 26px; }
            .toolbar { flex-direction: column; padding: 16px; gap: 12px; }
            .toolbar button { width: 100%; }
            .th-heat, .col-heatmap, .separator { display: none; }
            .th-path { width: 62%; }
            .th-edit { width: 20%; }
            .th-action { width: 18%; }
            .mobile-bar-container { display: flex; }
            th, td { padding: 12px 10px; }
            .site-footer { flex-direction: column; gap: 12px; text-align: center; border-top: none; padding-top: 10px; }
            .footer-left { flex-direction: column; gap: 6px; }
            .status-line { background: var(--bg); padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border); display: flex; align-items: center; gap: 8px; font-weight: 500; font-size: 12px; }
            .pagination-bar { flex-direction: column; gap: 12px; align-items: stretch; }
            .pagination-controls { justify-content: space-between; }
            
            /* ä¼˜åŒ–ç§»åŠ¨ç«¯ key æ˜¾ç¤º */
            .key-badge {
                max-width: 100%;
                margin-top: 8px;
            }
            .key-badge span {
                max-width: 100%;
                font-size: 9px;
            }
        }
    </style>
</head>
<body>

<div id="app" class="app-layout">
    <div class="toast-container">
        <div class="toast" :class="{ show: toast.visible }">
            <span class="toast-icon">{{ toast.icon }}</span> {{ toast.msg }}
        </div>
    </div>

    <div v-if="!isLoggedIn" class="login-wrapper">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 20px;">ğŸ›¡ï¸</div>
            <h2 style="margin: 0 0 10px 0; color: var(--text-main);">Console Login</h2>
            <p style="margin: 0 0 30px 0; color: var(--text-sub); font-size: 13px; line-height: 1.5;">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥ä»¥è®¿é—®<br>å…¨ç«™æµé‡ç›‘æ§æ•°æ®</p>
            <input type="password" v-model="password" class="search-input" style="width: 100%; box-sizing: border-box; margin-bottom: 20px; text-align:center; letter-spacing: 2px;" placeholder="â—â—â—â—â—â—â—â—" @keyup.enter="login">
            <button class="btn btn-primary" style="width: 100%; height: 44px; font-size: 14px;" @click="login">éªŒè¯èº«ä»½</button>
        </div>
    </div>

    <div v-else class="main-content">
        <header class="page-header">
            <div class="page-title">
                <h1>å…¨ç«™è®¿é—®é‡æ•°æ®ç›‘æ§å±</h1>
                <span>Total Site Traffic Analytics Dashboard</span>
            </div>
            <button class="theme-toggle" @click="toggleTheme" :title="theme === 'dark' ? 'åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æš—è‰²æ¨¡å¼'">
                <svg v-if="theme === 'dark'" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29zm1.41-13.78c-.39-.39-1.02-.39-1.41 0a.996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29zM7.28 17.17c-.39-.39-1.02-.39-1.41 0a.996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29z"></path></svg>
                <svg v-else viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
            </button>
        </header>

        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-label">å…¨ç«™æ€» PV (Site Total)</div>
                <!-- ä¿®å¤: æ˜¾ç¤ºç‹¬ç«‹è·å–çš„ site_total_pv -->
                <div class="stat-value">{{ globalTotalPV.toLocaleString() }}</div>
                <div class="stat-desc">
                    <span style="color: var(--success);">â—</span> å®æ—¶ç´¯è®¡è®¿é—®
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ”¶å½• URL æ€»æ•° (Total Keys)</div>
                <!-- ä¿®å¤: åˆå§‹ä¸º --ï¼Œåå°æ‰«æå®Œæˆåæ˜¾ç¤ºæ•°å­— -->
                <div class="stat-value" style="color: var(--primary);">
                    {{ totalUrlCount !== null ? totalUrlCount.toLocaleString() : '--' }}
                </div>
                <div class="stat-desc">
                    <!-- æ˜¾ç¤ºæ‰«æåŠ¨ç”»çŠ¶æ€ -->
                    <span v-if="isScanning" style="display:flex; align-items:center; gap:6px; color: var(--primary);">
                        <div class="spinner" style="border-width:2px; width:10px; height:10px;"></div>
                        å…¨åº“ç»Ÿè®¡ä¸­...
                    </span>
                    <span v-else>
                        æœ‰æ•ˆé¡µé¢è·¯å¾„æ•°
                    </span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Top 1 çƒ­é—¨å†…å®¹ï¼ˆç¬¬ {{ currentPageIndex + 1 }} é¡µï¼‰</div>
                <div class="stat-value" style="font-size: 16px; margin-top: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" :title="topPage ? topPage.decodedUrl : ''">
                    <template v-if="topPage">
                        {{ topPage.decodedUrl === '/' ? 'æ ¹åŸŸåè½åœ°é¡µ' : topPage.decodedUrl }}
                        <span v-if="topPage.decodedUrl === '/'" class="root-badge">ROOT</span>
                    </template>
                    <template v-else>--</template>
                </div>
                <div class="stat-desc" v-if="topPage">è´¡çŒ®äº†å…¨ç«™ {{ calculateShare(topPage.value).toFixed(1) }}% çš„æµé‡</div>
            </div>
        </div>

        <div class="toolbar">
            <!-- æœç´¢æ¡† -->
            <div style="flex:1; display:flex; gap:8px; align-items:center;">
                <input type="text" v-model="searchQuery" class="search-input" placeholder="è¾“å…¥è·¯å¾„æˆ–å…³é”®è¯ï¼Œå›è½¦æœç´¢å…¨ç«™..." @keyup.enter="triggerSearch">
                <button class="btn btn-primary" @click="triggerSearch" :disabled="loading">
                    ğŸ” æœç´¢ / æ‰«æ
                </button>
            </div>
            <button class="btn" @click="resetView" :disabled="loading">
                <span v-if="loading && !searchMode">
                    <div class="spinner" style="width:10px; height:10px;"></div> åŠ è½½ä¸­...
                </span>
                <span v-else>âŸ³ é‡ç½® / åˆ·æ–°</span>
            </button>
            <button class="btn btn-danger" @click="logout">é€€å‡º</button>
        </div>

        <div class="table-container">
            <!-- æœç´¢æ¨¡å¼ä¸‹çš„çŠ¶æ€æç¤ºæ¡ -->
            <div v-if="searchMode" style="padding: 10px 20px; background: var(--primary-light); color: var(--primary); font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div class="spinner" v-if="!searchComplete"></div>
                    <span>{{ searchComplete ? 'å…¨ç«™æœç´¢å®Œæˆ' : 'æ­£åœ¨æ‰«æå…¨ç«™æ•°æ®...' }} (å·²æ‰¾åˆ° {{ items.length }} æ¡åŒ¹é…)</span>
                </div>
                <span v-if="!searchComplete" style="cursor: pointer; opacity: 0.8; text-decoration: underline;" @click="stopSearch">åœæ­¢æ‰«æ</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th class="th-path">èµ„æºè·¯å¾„ / Resource Path</th>
                        <th class="th-heat col-heatmap">çƒ­åº¦åˆ†å¸ƒ</th>
                        <th class="th-edit">ä¿®æ­£å€¼</th>
                        <th class="th-action">ç®¡ç†</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in items" :key="item.key">
                        <td>
                            <div class="path-primary">
                                <span v-if="item.key === 'site_total_pv'" class="badge badge-core">ROOT</span>
                                {{ item.decodedUrl === '/' ? 'æ ¹åŸŸåè½åœ°é¡µ' : item.decodedUrl }}
                                <span v-if="item.decodedUrl === '/'" class="root-badge">ROOT</span>
                            </div>
                            <div class="key-badge" @click="copy(item.key)" :title="'ç‚¹å‡»å¤åˆ¶å®Œæ•´ Key:\n' + item.key">
                                <span>{{ truncateKey(item.key) }}</span>
                            </div>
                            <div class="mobile-bar-container">
                                <span style="font-size:11px; font-weight:600; color:var(--primary); min-width:35px;">{{ formatNumber(item.value) }}</span>
                                <div class="pv-bar-bg" style="height: 4px;">
                                    <div class="pv-bar-fill" :style="{ width: calculateRelative(item.value) + '%' }"></div>
                                </div>
                            </div>
                        </td>
                        <td class="col-heatmap">
                            <div class="pv-container">
                                <div class="pv-number">{{ Number(item.value).toLocaleString() }}</div>
                                <div class="pv-bar-bg">
                                    <div class="pv-bar-fill" :style="{ width: calculateRelative(item.value) + '%' }"></div>
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <input type="number" v-model="item.newValue" class="edit-input" @focus="$event.target.select()">
                        </td>
                        <td style="text-align: right;">
                            <div v-if="item.newValue != item.value">
                                <button class="btn btn-primary" style="padding: 0 10px; font-size: 12px; height: 32px;" @click="updateItem(item)">ä¿å­˜</button>
                            </div>
                            <div v-else>
                                <button class="btn btn-danger" style="padding: 0 10px; font-size: 12px; height: 32px; background:transparent; border:none;" @click="deleteItem(item)">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="items.length === 0 && !loading">
                        <td colspan="4" class="td-no-border" style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;">{{ fetchError ? 'âš ï¸' : 'ğŸ“­' }}</div>
                            <div style="font-weight: 600; color: var(--text-main);">{{ fetchError ? 'æ•°æ®åŠ è½½å¼‚å¸¸' : 'æš‚æ— æ•°æ®' }}</div>
                            <div style="font-size: 13px; color: var(--text-sub); margin-top: 6px;">
                                {{ fetchError || (searchMode ? 'æœªåœ¨å…¨ç«™æ‰¾åˆ°åŒ…å«è¯¥å…³é”®è¯çš„è·¯å¾„ã€‚' : 'æ‚¨çš„ç«™ç‚¹ä¼¼ä¹è¿˜æ²¡æœ‰äº§ç”Ÿè®¿é—®æµé‡ã€‚') }}
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- åˆ†é¡µæ  (ä»…åœ¨éæœç´¢æ¨¡å¼ä¸‹æ˜¾ç¤º) -->
            <div class="pagination-bar" v-if="isLoggedIn && !searchMode">
                <div class="page-info">
                    å½“å‰ç¬¬ {{ currentPageIndex + 1 }} é¡µ
                </div>
                <div class="pagination-controls">
                    <button class="btn" style="height: 36px;" @click="prevPage" :disabled="loading || currentPageIndex === 0">
                        &larr; ä¸Šä¸€é¡µ
                    </button>
                    <button class="btn" style="height: 36px;" @click="nextPage" :disabled="loading || complete">
                        ä¸‹ä¸€é¡µ &rarr;
                    </button>
                </div>
            </div>
        </div>

        <footer class="site-footer">
            <div class="footer-left">
                <div class="status-line">
                    <span class="status-dot"></span> 
                    <span>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
                </div>
                <span class="separator">|</span>
                <div style="opacity: 0.8; font-size: 12px;">æ•°æ®æ›´æ–°äº {{ lastUpdateTime }}</div>
            </div>
            <div style="color: var(--text-muted); font-size: 12px; font-family: monospace;">v1.0.0 æ­£å¼ç‰ˆ</div>
        </footer>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // åŸºç¡€çŠ¶æ€
            const isLoggedIn = ref(false);
            const password = ref('');
            const items = ref([]); 
            
            // åˆ†é¡µç›¸å…³
            const pageCursors = ref([null]); 
            const currentPageIndex = ref(0); 
            const complete = ref(false); 
            
            // ç»Ÿè®¡ä¸æœç´¢çŠ¶æ€
            const loading = ref(false);
            const searchQuery = ref('');
            const searchMode = ref(false); // æ˜¯å¦å¤„äºæœç´¢æ¨¡å¼
            const searchComplete = ref(false); // æœç´¢æ˜¯å¦ç»“æŸ
            const abortController = ref(null); // ç”¨äºä¸­æ–­è¯·æ±‚
            
            // å…¨ç«™ç»Ÿè®¡æ•°æ®
            const globalTotalPV = ref(0); 
            const totalUrlCount = ref(null); // nullè¡¨ç¤ºæœªåŠ è½½
            const isScanning = ref(false); // æ˜¯å¦æ­£åœ¨åå°ç»Ÿè®¡

            const fetchError = ref(''); 
            const lastUpdateTime = ref('-');
            const toast = ref({ visible: false, msg: '', icon: '' });
            const theme = ref('light');

            onMounted(() => {
                const stored = localStorage.getItem('dash_pwd');
                if (stored) { password.value = stored; login(); }
                updateTime();
                initTheme();
            });

            // --- æ ¸å¿ƒåŠŸèƒ½ 1: è·å–å…¨ç«™æ€» PV ---
            // ä¾èµ–åç«¯ API: æ”¯æŒ prefix å‚æ•°
            const fetchGlobalTotal = async () => {
                try {
                    const res = await fetch(`/api/admin?action=list&prefix=site_total_pv`, { 
                        headers: { 'X-Auth-Token': password.value } 
                    });
                    const data = await res.json();
                    if (data.data && data.data.length > 0) {
                        const totalItem = data.data.find(i => i.key === 'site_total_pv');
                        if (totalItem) globalTotalPV.value = Number(totalItem.value);
                    }
                } catch (e) { console.warn("è·å–å…¨å±€æ€»æ•°å¤±è´¥:", e); }
            };

            // --- æ ¸å¿ƒåŠŸèƒ½ 2: åå°é™é»˜æ‰«æå…¨åº“ç»Ÿè®¡ URL æ€»æ•° ---
            // ä¾èµ–åç«¯ API: æ”¯æŒ onlyKeys=true å’Œ limit å‚æ•°
            const scanTotalCounts = async () => {
                if (isScanning.value) return;
                isScanning.value = true;
                totalUrlCount.value = 0;
                
                let cursor = null;
                let isDone = false;
                let count = 0;

                try {
                    while (!isDone) {
                        // å¦‚æœç”¨æˆ·é€€å‡ºäº†ï¼Œåœæ­¢å¾ªç¯
                        if (!isLoggedIn.value) break;

                        // ä½¿ç”¨é«˜é€Ÿæ¨¡å¼: onlyKeys=true, limit=256
                        let url = `/api/admin?action=list&onlyKeys=true&limit=256`;
                        if (cursor) url += `&cursor=${cursor}`;

                        const res = await fetch(url, { headers: { 'X-Auth-Token': password.value } });
                        if (!res.ok) break;
                        
                        const data = await res.json();
                        const pageKeys = data.data || [];
                        
                        // è¿‡æ»¤æ‰ç³»ç»Ÿä¿ç•™Key
                        const validKeys = pageKeys.filter(k => (k.key || k.name || k) !== 'site_total_pv');
                        count += validKeys.length;
                        totalUrlCount.value = count;

                        if (data.complete) {
                            isDone = true;
                        } else {
                            cursor = data.cursor;
                        }
                        // ç¨å¾®ä¼‘çœ ï¼Œé˜²æ­¢è§¦å‘å­è¯·æ±‚é€Ÿç‡é™åˆ¶
                        await new Promise(r => setTimeout(r, 50));
                    }
                } catch (e) {
                    console.error("åå°ç»Ÿè®¡ä¸­æ–­", e);
                } finally {
                    isScanning.value = false;
                }
            };

            // --- æ ¸å¿ƒåŠŸèƒ½ 3: å¸¸è§„åˆ—è¡¨åŠ è½½ ---
            const fetchData = async (targetCursor) => {
                if (loading.value) return;
                loading.value = true;
                fetchError.value = ''; 

                try {
                    let url = `/api/admin?action=list`; // é»˜è®¤ limit ç”±åç«¯å†³å®š(20-30)
                    if (targetCursor) url += `&cursor=${targetCursor}`;
                    
                    const res = await fetch(url, { headers: { 'X-Auth-Token': password.value } });
                    if (res.status === 401) { logout(); showToast("å¯†é’¥å¤±æ•ˆ", 'error'); return; }
                    
                    const data = await res.json();
                    items.value = processItems(data.data);
                    complete.value = data.complete;
                    
                    // è®°å½•ä¸‹ä¸€é¡µæ¸¸æ ‡
                    if (!data.complete && data.cursor && currentPageIndex.value === pageCursors.value.length - 1) {
                        pageCursors.value.push(data.cursor);
                    }
                    updateTime();
                } catch (e) {
                    fetchError.value = "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨";
                } finally { loading.value = false; }
            };

            // --- æ ¸å¿ƒåŠŸèƒ½ 4: å…¨ç«™æœç´¢æ¨¡å¼ ---
            const triggerSearch = () => {
                if (!searchQuery.value.trim()) {
                    resetView();
                    return;
                }
                searchMode.value = true;
                searchComplete.value = false;
                items.value = []; 
                loading.value = true;

                if (abortController.value) abortController.value.abort();
                abortController.value = new AbortController();

                performGlobalSearch(null);
            };

            const performGlobalSearch = async (cursor) => {
                try {
                    // æœç´¢æ—¶éœ€è¦ Valuesï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ onlyKeys
                    // å»ºè®®åç«¯é»˜è®¤ limit ä¸º 20-30ï¼Œé¿å…ä¸€æ¬¡æ‹‰å–å¤ªå¤šå¯¼è‡´è¶…æ—¶
                    let url = `/api/admin?action=list`;
                    if (cursor) url += `&cursor=${cursor}`;
                    
                    const res = await fetch(url, { 
                        headers: { 'X-Auth-Token': password.value },
                        signal: abortController.value.signal 
                    });
                    
                    const data = await res.json();
                    const pageData = data.data || [];
                    
                    // å‰ç«¯ç­›é€‰åŒ¹é…é¡¹
                    const query = searchQuery.value.toLowerCase();
                    const matches = processItems(pageData).filter(i => 
                        i.key !== 'site_total_pv' && 
                        (i.key.toLowerCase().includes(query) || i.decodedUrl.toLowerCase().includes(query))
                    );
                    
                    items.value = [...items.value, ...matches];

                    if (!data.complete && data.cursor) {
                        requestAnimationFrame(() => performGlobalSearch(data.cursor));
                    } else {
                        loading.value = false;
                        searchComplete.value = true;
                        showToast(`æœç´¢ç»“æŸï¼Œæ‰¾åˆ° ${items.value.length} æ¡`, 'success');
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        console.error(e);
                        loading.value = false;
                    }
                }
            };

            const stopSearch = () => {
                if (abortController.value) abortController.value.abort();
                loading.value = false;
                searchComplete.value = true;
                showToast("å·²åœæ­¢æ‰«æ");
            };

            // --- è¾…åŠ©é€»è¾‘ ---
            const resetView = () => {
                searchMode.value = false;
                searchQuery.value = '';
                items.value = [];
                pageCursors.value = [null];
                currentPageIndex.value = 0;
                complete.value = false;
                if (abortController.value) abortController.value.abort();
                fetchData(null);
                fetchGlobalTotal();
                // å¦‚æœ totalUrlCount è¿˜æ²¡ç»Ÿè®¡å®Œï¼Œå¯ä»¥é‡æ–°è§¦å‘
                if (totalUrlCount.value === null) scanTotalCounts();
            };

            const processItems = (rawData) => {
                return (rawData || []).map(i => ({ 
                    ...i, 
                    newValue: i.value, 
                    decodedUrl: decodeKey(i.key) 
                }));
            };

            const nextPage = () => {
                if (complete.value) return;
                currentPageIndex.value++;
                fetchData(pageCursors.value[currentPageIndex.value]);
            };
            const prevPage = () => {
                if (currentPageIndex.value === 0) return;
                currentPageIndex.value--;
                fetchData(pageCursors.value[currentPageIndex.value]);
            };

            const login = () => {
                if (!password.value) return;
                isLoggedIn.value = true;
                localStorage.setItem('dash_pwd', password.value);
                
                // å¹¶è¡Œå¯åŠ¨æ‰€æœ‰ä»»åŠ¡
                items.value = [];
                pageCursors.value = [null];
                currentPageIndex.value = 0;
                
                fetchData(null);       // åŠ è½½åˆ—è¡¨
                fetchGlobalTotal();    // åŠ è½½æ€»PV
                scanTotalCounts();     // å¯åŠ¨åå°ç»Ÿè®¡URLæ€»æ•°
            };

            const logout = () => {
                isLoggedIn.value = false;
                password.value = '';
                localStorage.removeItem('dash_pwd');
                // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„æ‰«æ
                isScanning.value = false;
                if (abortController.value) abortController.value.abort();
            };

            const deleteItem = async (item) => {
                if (!confirm(`ç¡®å®šåˆ é™¤ "${item.decodedUrl}" å—?`)) return;
                try {
                    await fetch('/api/admin?action=delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Auth-Token': password.value },
                        body: JSON.stringify({ key: item.key })
                    });
                    items.value = items.value.filter(i => i.key !== item.key);
                    showToast("åˆ é™¤æˆåŠŸ");
                    // åŒæ­¥æ‰£å‡æœ¬åœ°æ€»æ•°
                    if (item.key !== 'site_total_pv') {
                        const diff = Number(item.value) || 0;
                        globalTotalPV.value = Math.max(0, globalTotalPV.value - diff);
                        // æ›´æ–°åç«¯
                        fetch('/api/admin?action=update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-Auth-Token': password.value },
                            body: JSON.stringify({ key: 'site_total_pv', value: String(globalTotalPV.value) })
                        });
                        // æ›´æ–°è®¡æ•°
                        if (totalUrlCount.value > 0) totalUrlCount.value--;
                    }
                } catch(e) { showToast("æ“ä½œå¤±è´¥", 'error'); }
            };

            const updateItem = async (item) => {
                try {
                    const res = await fetch('/api/admin?action=update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Auth-Token': password.value },
                        body: JSON.stringify({ key: item.key, value: String(item.newValue) })
                    });
                    if(res.ok) { 
                        if (item.key === 'site_total_pv') globalTotalPV.value = Number(item.newValue);
                        item.value = item.newValue; 
                        showToast("ä¿å­˜æˆåŠŸ"); 
                    } else throw new Error();
                } catch(e) { showToast("æ›´æ–°å¤±è´¥", 'error'); }
            };

            // UI è¾…åŠ©
            const initTheme = () => {
                const cached = localStorage.getItem('theme');
                if (cached) theme.value = cached;
                else if (window.matchMedia('(prefers-color-scheme: dark)').matches) theme.value = 'dark';
                document.documentElement.setAttribute('data-theme', theme.value);
            };
            const toggleTheme = () => {
                theme.value = theme.value === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme.value);
                localStorage.setItem('theme', theme.value);
            };
            const showToast = (msg, type = 'success') => {
                toast.value = { visible: true, msg, icon: type === 'success' ? 'âœ…' : (type === 'error' ? 'âŒ' : 'ğŸ“‹') };
                setTimeout(() => { toast.value.visible = false; }, 2500);
            };
            const updateTime = () => { lastUpdateTime.value = new Date().toLocaleTimeString('zh-CN', { hour12: false }); };
            const formatNumber = (num) => {
                const n = Number(num);
                if(n >= 10000) return (n/10000).toFixed(1) + 'w';
                if(n >= 1000) return (n/1000).toFixed(1) + 'k';
                return n;
            };
            const copy = (text) => { 
                navigator.clipboard.writeText(text).then(() => showToast("Key å·²å¤åˆ¶", 'copy')); 
            };

            const truncateKey = (key) => {
                if (!key) return '';
                if (key.length <= 25) return key;
                // ç§»åŠ¨ç«¯æ›´çŸ­çš„æˆªæ–­
                if (window.innerWidth <= 768) {
                    return key.substring(0, 15) + '...' + key.substring(key.length - 8);
                }
                return key.substring(0, 20) + '...' + key.substring(key.length - 8);
            };

            const decodeKey = (key) => {
                if (key === 'site_total_pv') return 'å…¨ç«™æ€»è®¡ (SYSTEM ROOT)';
                let cleanKey = key.startsWith('_') ? key.substring(1) : key;
                const segments = cleanKey.split('_').map(seg => {
                    if (seg.startsWith('B64:')) {
                        let b64 = seg.substring(4).replace(/:A/g, '+').replace(/:B/g, '/');
                        while (b64.length % 4 !== 0) b64 += '=';
                        try { return new TextDecoder().decode(Uint8Array.from(atob(b64), c => c.charCodeAt(0))); } catch (e) { return seg; }
                    }
                    return seg;
                });
                let rawPath = '/' + segments.join('/');
                try { return decodeURIComponent(rawPath); } catch (e) { return rawPath; }
            };

            // Computed
            const maxPV = computed(() => {
                // è®¡ç®—ç›¸å¯¹çƒ­åº¦æ¡æ—¶ï¼Œæ’é™¤ total_pvï¼Œä»…æ¯”è¾ƒé¡µé¢ä¹‹é—´çš„çƒ­åº¦
                const pages = items.value.filter(i => i.key !== 'site_total_pv');
                return pages.length ? Math.max(...pages.map(i => Number(i.value) || 0)) : 0;
            });
            
            const topPage = computed(() => {
                const pages = items.value.filter(i => i.key !== 'site_total_pv');
                return pages.sort((a,b) => Number(b.value) - Number(a.value))[0];
            });

            const calculateRelative = (val) => maxPV.value ? Math.min(100, (Number(val) / maxPV.value) * 100) : 0;
            const calculateShare = (val) => globalTotalPV.value ? (Number(val) / globalTotalPV.value) * 100 : 0;

            return {
                isLoggedIn, password, login, logout, items,
                currentPageIndex, nextPage, prevPage, complete, resetView,
                updateItem, deleteItem, copy, truncateKey,
                globalTotalPV, topPage, fetchError, lastUpdateTime, formatNumber, toast, theme, toggleTheme, loading, 
                searchQuery, searchMode, searchComplete, triggerSearch, stopSearch, 
                totalUrlCount, isScanning,
                calculateRelative, calculateShare
            };
        }
    }).mount('#app');
</script>
</body>
</html>