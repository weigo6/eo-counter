<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµé‡ç›‘æ§å¤§å±</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; }
        .login-box { text-align: center; margin-top: 50px; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        button { padding: 8px 16px; background: #0052d9; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #003cab; }
        button.danger { background: #d54941; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #fafafa; }
        .key-cell { font-family: monospace; color: #666; font-size: 12px; word-break: break-all; }
        .url-cell { color: #0052d9; font-weight: 500; }
        .pagination { margin-top: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="container" id="app">
    <!-- ç™»å½•è§†å›¾ -->
    <div v-if="!isLoggedIn" class="login-box">
        <h2>ç®¡ç†å‘˜ç™»å½•</h2>
        <input type="password" v-model="password" placeholder="è¯·è¾“å…¥ ADMIN_PASSWORD" @keyup.enter="login">
        <button @click="login">è¿›å…¥</button>
    </div>

    <!-- æ•°æ®è§†å›¾ -->
    <div v-else>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>è®¿é—®æ•°æ®ç®¡ç†</h1>
            <button @click="logout" style="background:#888">é€€å‡º</button>
        </div>
        
        <div v-if="loading">åŠ è½½ä¸­...</div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40%">åŸå§‹è·¯å¾„ (è§£ç æ¨æµ‹)</th>
                    <th style="width: 30%">KV Key</th>
                    <th style="width: 10%">PV</th>
                    <th style="width: 20%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="item in items" :key="item.key">
                    <td>
                        <div class="url-cell">{{ decodeKey(item.key) }}</div>
                    </td>
                    <td class="key-cell">{{ item.key }}</td>
                    <td>
                        <input type="number" v-model="item.newValue" style="width: 60px" />
                    </td>
                    <td>
                        <button @click="updateItem(item)">ä¿å­˜</button>
                        <button class="danger" @click="deleteItem(item.key)">åˆ é™¤</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="pagination">
            <button v-if="!complete" @click="loadMore">åŠ è½½æ›´å¤š</button>
            <span v-else style="color:#999">å·²åŠ è½½å…¨éƒ¨æ•°æ®</span>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Vue3 ç®€åŒ–å¼€å‘ -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const isLoggedIn = ref(false);
            const password = ref('');
            const items = ref([]);
            const cursor = ref(null);
            const complete = ref(false);
            const loading = ref(false);

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„å¯†ç 
            onMounted(() => {
                const stored = localStorage.getItem('dash_pwd');
                if (stored) {
                    password.value = stored;
                    login();
                }
            });

            const login = () => {
                if (!password.value) return;
                isLoggedIn.value = true;
                localStorage.setItem('dash_pwd', password.value);
                fetchData(true);
            };

            const logout = () => {
                isLoggedIn.value = false;
                password.value = '';
                localStorage.removeItem('dash_pwd');
                items.value = [];
            };

            // è·å–æ•°æ®
            const fetchData = async (reset = false) => {
                if (loading.value) return;
                loading.value = true;
                
                try {
                    let url = `/api/admin?action=list`;
                    if (!reset && cursor.value) url += `&cursor=${cursor.value}`;
                    
                    const res = await fetch(url, {
                        headers: { 'X-Auth-Token': password.value }
                    });

                    if (res.status === 401) {
                        alert("å¯†ç é”™è¯¯");
                        logout();
                        return;
                    }

                    const data = await res.json();
                    
                    // ä¸ºæ¯ä¸€é¡¹æ·»åŠ  newValue å­—æ®µç”¨äºç¼–è¾‘
                    const newItems = data.data.map(i => ({...i, newValue: i.value}));
                    
                    if (reset) {
                        items.value = newItems;
                    } else {
                        items.value = [...items.value, ...newItems];
                    }
                    
                    cursor.value = data.cursor;
                    complete.value = data.complete;

                } catch (e) {
                    console.error(e);
                    alert("åŠ è½½å¤±è´¥");
                } finally {
                    loading.value = false;
                }
            };

            const loadMore = () => fetchData(false);

            // æ›´æ–°æ•°æ®
            const updateItem = async (item) => {
                if (!confirm(`ç¡®å®šå°†æ•°å€¼ä¿®æ”¹ä¸º ${item.newValue}?`)) return;
                try {
                    const res = await fetch('/api/admin?action=update', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Auth-Token': password.value 
                        },
                        body: JSON.stringify({ key: item.key, value: item.newValue })
                    });
                    if (res.ok) {
                        item.value = item.newValue;
                        alert("æ›´æ–°æˆåŠŸ");
                    } else {
                        throw new Error();
                    }
                } catch(e) {
                    alert("æ›´æ–°å¤±è´¥");
                }
            };

            // åˆ é™¤æ•°æ®
            const deleteItem = async (key) => {
                if (!confirm("ç¡®å®šåˆ é™¤æ­¤è®°å½•?")) return;
                try {
                    const res = await fetch('/api/admin?action=delete', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Auth-Token': password.value 
                        },
                        body: JSON.stringify({ key })
                    });
                    if (res.ok) {
                        items.value = items.value.filter(i => i.key !== key);
                    }
                } catch(e) {
                    alert("åˆ é™¤å¤±è´¥");
                }
            };

            // è§£ç  Key ä»¥æ˜¾ç¤ºä¸ºå¯è¯» URL (ç°ä»£åŒ–ç‰ˆæœ¬)
            const decodeKey = (key) => {
                if (key === 'site_total_pv') return 'ğŸ  å…¨ç«™æ€»è®¿é—®é‡';
                
                try {
                    // åŒ¹é… B_ å¼€å¤´çš„ç¼–ç æ®µ
                    return key.replace(/B_([a-zA-Z0-9:A:B]+)/g, (match, b64safe) => {
                        // 1. è¿˜åŸ Base64 ç‰¹æ®Šå­—ç¬¦
                        let b64 = b64safe.replace(/:A/g, '+').replace(/:B/g, '/');
                        // è¡¥é½ padding (=)
                        while (b64.length % 4 !== 0) b64 += '=';
                        
                        try {
                            // === å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ TextDecoder æ›¿ä»£ escape ===
                            // 1. Base64 -> äºŒè¿›åˆ¶å­—ç¬¦ä¸²
                            const binString = atob(b64);
                            // 2. äºŒè¿›åˆ¶å­—ç¬¦ä¸² -> Uint8Array
                            const bytes = Uint8Array.from(binString, c => c.charCodeAt(0));
                            // 3. Uint8Array -> UTF-8 å­—ç¬¦ä¸²
                            return new TextDecoder().decode(bytes);
                        } catch (e) {
                            return match;
                        }
                    }).replace(/_/g, '/');
                } catch (e) {
                    return key;
                }
            };

            return {
                isLoggedIn, password, login, logout,
                items, loadMore, complete, loading,
                updateItem, deleteItem, decodeKey
            };
        }
    }).mount('#app');
</script>
</body>
</html>